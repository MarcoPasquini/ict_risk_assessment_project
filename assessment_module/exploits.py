from pathlib import Path
from pwn import *
import subprocess
import os

SUCCESS_RETURN = 11
EXPLOITS_DIR = "exploits"
EXPLOITS_FORMAT = ".py"

def run_exploits(filepath: str, repeats: int):
    trials = 0
    successes = 0
    results = {}
    active_exploits = retrive_exploits_for_binary(filepath)
    for exploit in active_exploits:
        successes += repeat_exploit(exploit, repeats, filepath)
        trials += repeats
    if trials:
        results = {
            "trials": trials,
            "successes": successes,
            "p_hat": successes/trials
        }
    return results

def repeat_exploit(exploit: str, repeats: int, target: str):
    counter_success = 0
    for i in range(repeats):
        if(run_exploit(exploit, target) == SUCCESS_RETURN):
            counter_success += 1 
    return counter_success

def run_exploit(exploit_path: str, target: str):
    return subprocess.run(
        ["python", exploit_path, target],
        stderr=subprocess.DEVNULL,
        stdout=subprocess.DEVNULL
    ).returncode

def retrive_exploits_for_binary(binary_path: str):
    dir, name = get_dir_name_from_filepath(binary_path)
    dir = adjust_exploit_dir(dir)
    exploits = []
    for file in os.listdir(dir):
        if is_valid_exploit(file, name):
            exploits.append(Path(dir) / file)
    return exploits

def get_dir_name_from_filepath(filepath: str):
    dir_idx = filepath.rfind('/')
    dir = filepath[:dir_idx]
    name = filepath[dir_idx+1:]
    name = name[:name.find('-')]
    return dir, name

def adjust_exploit_dir(dir: str):
    adjusted_dir = (Path(get_dir_name_from_filepath(dir)[0]) / EXPLOITS_DIR)
    return adjusted_dir

def is_valid_exploit(file: str, name: str):
    return file.startswith(name) and file.endswith(EXPLOITS_FORMAT)