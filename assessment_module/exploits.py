from pathlib import Path
from pwn import *
import subprocess
import os

def run_exploits(filepath, repeats=10):
    results = []
    active_exploits = retrive_exploits_for_binary(filepath)
    for exploit in active_exploits:
        results.append(repeat_exploit(exploit, repeats, filepath))
        
    return results

def repeat_exploit(exploit, repeats, target):
    counter_success = 0
    for i in range(repeats):
        if(run_exploit(exploit, target) == 11):
            counter_success += 1 
    result = {
        "exploit": str(exploit),
        "runs": repeats,
        "successes": counter_success
    }
    return result

def run_exploit(exploit_path, target):
    return subprocess.run(
        ["python", exploit_path, target],
        stderr=subprocess.DEVNULL,
        stdout=subprocess.DEVNULL
    ).returncode

def retrive_exploits_for_binary(binary_path):
    dir, name = get_dir_name_from_filepath(binary_path)
    exploits = []
    for file in os.listdir(dir):
        if is_valid_exploit(file, name):
            exploits.append(Path(dir) / file)
    return exploits

def get_dir_name_from_filepath(filepath):
    dir_idx = filepath.rfind('/')
    dir = filepath[:dir_idx]
    name = filepath[dir_idx+1:]
    name = name[:name.find('-')]
    return dir, name

def is_valid_exploit(file, name):
    return file.startswith(name) and file.endswith('.py')
