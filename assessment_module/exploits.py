from pathlib import Path
from pwn import *
import subprocess
import os
from vm_handler import *

SUCCESS_RETURN = 11
EXPLOITS_DIR = "exploits"
EXPLOITS_FORMAT = ".py"

def run_exploits(filepath: str, repeats: int, max_cpu_usage_per_exploit: int):
    trials = 0
    successes = 0
    results = {}
    active_exploits = retrive_exploits_for_binary(filepath)
    for exploit in active_exploits:
        successes += repeat_exploit(exploit, repeats, filepath, max_cpu_usage_per_exploit)
        trials += repeats
    if trials:
        results = {
            "trials": trials,
            "successes": successes,
            "p_hat": successes/trials
        }
    return results

def repeat_exploit(exploit: str, repeats: int, target: str, max_cpu_usage_per_exploit: int):
    counter_success = 0
    for i in range(repeats):
        print(f"[HOST] Running exploit {exploit} on target {target} -- {i+1}/{repeats}")
        if(run_exploit(exploit, target, max_cpu_usage_per_exploit) == SUCCESS_RETURN):
            counter_success += 1 
    return counter_success

def run_exploit(exploit_path: str, target: str, max_cpu_usage_per_exploit: int):
    restore_snapshot()
    start_vm(max_cpu_usage_per_exploit)
    ssh = wait_for_ssh()
    exit_code = 0

    try:
        upload_and_prepare(ssh, target, f"{REMOTE_DIR}/vuln_program")
        upload_and_prepare(ssh, exploit_path, f"{REMOTE_DIR}/exploit.py")

        local_dir = os.path.dirname(str(target)) 
        local_libc = os.path.join(local_dir, "libc.so.6")

        if os.path.exists(local_libc):
            upload_and_prepare(ssh, local_libc, f"{REMOTE_DIR}/libc.so.6")
        else:
            pass

        print(" -  Triggering Agent...")
        stdin, stdout, stderr = ssh.exec_command(f"export TERM=xterm && python3 {REMOTE_DIR}/exploit.py {REMOTE_DIR}/vuln_program")
        exit_code = stdout.channel.recv_exit_status()

    finally:
        print(" -  Done.")
        print(" -  Closing SSH...")
        ssh.close()
        subprocess.run(["VBoxManage", "controlvm", VM_NAME, "poweroff"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    return exit_code

def retrive_exploits_for_binary(binary_path: str):
    dir, name = get_dir_name_from_filepath(binary_path)
    dir = Path(dir) / EXPLOITS_DIR

    exploits = []
    for file in os.listdir(dir):
        if is_valid_exploit(file, name):
            exploits.append(Path(dir) / file)
    return exploits

def get_dir_name_from_filepath(filepath: str):
    dir_idx = filepath.rfind('/')
    dir = filepath[:dir_idx]
    name = filepath[dir_idx+1:]
    name = name[:name.find('-')]
    return dir, name

def is_valid_exploit(file: str, name: str):
    return file.startswith(name) and file.endswith(EXPLOITS_FORMAT)